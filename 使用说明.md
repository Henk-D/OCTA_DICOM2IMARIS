# Zeiss Cirrus OCTA DICOM转TIFF转换器

## 功能概述

专门用于转换Zeiss Cirrus HD-OCT导出的OCTA DICOM文件为Imaris可读的TIFF格式。

### 主要特性

✅ **自动修复损坏的DICOM元数据**
- 修复PhotometricInterpretation字段中的垃圾字符
- 修复NumberOfFrames、Rows、Columns中的空字节

✅ **智能处理维度错误**
- 自动检测并修正Columns/Frames维度互换问题
- 适应不同的扫描分辨率（245x245x1024, 490x490x1024等）

✅ **支持JPEG 2000压缩**
- 使用pylibjpeg-openjpeg库解压缩
- 容错处理，跳过无法读取的文件

✅ **自动选择最佳体积**
- 从多个文件中自动选择对比度最好的体积
- 过滤掉2D切片和损坏的数据

✅ **完整输出**
- TIFF文件（带正确的体素大小元数据）
- NumPy数组（.npy）
- 元数据JSON文件
- 预览图（MIP投影）

## 环境要求

### Python版本
- Python 3.8或更高版本

### 依赖库

```bash
pip install pydicom numpy tifffile matplotlib pylibjpeg pylibjpeg-openjpeg
```

或使用requirements.txt:
```bash
pip install -r requirements.txt
```

## 使用方法

### 基本用法

```bash
python Zeiss_OCTA_Converter.py <数据文件夹名称>
```

### 示例

```bash
# 转换HenkE433数据
python Zeiss_OCTA_Converter.py HenkE433

# 转换E361数据
python Zeiss_OCTA_Converter.py E361
```

### 数据文件夹位置

脚本会在以下位置搜索数据文件夹：
1. `OCTA_DICOM2IMARIS/DataFiles/<文件夹名>`
2. `../HenkOCTA_DataFiles/<文件夹名>`
3. `HenkOCTA_DataFiles/<文件夹名>`
4. `<文件夹名>`（当前目录）

## 输出文件

所有输出文件统一保存在 **`Results/<文件夹名>/`** 目录下。

### 1. TIFF文件 (`OCTA_<文件夹>.tif`)
- 3D图像数据（Z, Y, X）轴顺序
- ImageJ兼容格式
- 包含体素大小元数据
- **可直接在Imaris中打开**
- 位置：`Results/<文件夹>/OCTA_<文件夹>.tif`

### 2. NumPy数组 (`OCTA_<文件夹>.npy`)
- uint8格式
- 形状：(Y, X, Z)
- 用于Python后处理
- 位置：`Results/<文件夹>/OCTA_<文件夹>.npy`

### 3. 元数据 (`OCTA_<文件夹>_metadata.json`)
包含：
- 源文件信息
- 图像尺寸
- 体素大小（µm）
- 扫描参数
- 患者ID和研究日期
- 位置：`Results/<文件夹>/OCTA_<文件夹>_metadata.json`

### 4. 预览图 (`OCTA_<文件夹>_Preview.png`)
包含4个视图：
- En Face视图（MIP Z）
- 侧视图Y（MIP Y）
- 侧视图X（MIP X）
- 中心深度切片
- 位置：`Results/<文件夹>/OCTA_<文件夹>_Preview.png`

### 输出结构示例

```text
Results/
├── E361/
│   ├── OCTA_E361.tif
│   ├── OCTA_E361.npy
│   ├── OCTA_E361_metadata.json
│   └── OCTA_E361_Preview.png
├── HenkE433/
│   ├── OCTA_HenkE433.tif
│   ├── OCTA_HenkE433.npy
│   ├── OCTA_HenkE433_metadata.json
│   └── OCTA_HenkE433_Preview.png
└── HenkE436/
    ├── OCTA_HenkE436.tif
    ├── OCTA_HenkE436.npy
    ├── OCTA_HenkE436_metadata.json
    └── OCTA_HenkE436_Preview.png
```

## 在Imaris中使用

1. **打开TIFF文件**

   ```text
   File → Open → 选择 Results/<文件夹>/OCTA_<文件夹>.tif
   ```

2. **确认体素大小**
   体素大小已嵌入TIFF文件中，Imaris应该自动识别。
   
   如需手动设置：
   - Edit → Image Properties → Voxel Size
   - 参考metadata.json文件中的voxel_size_um值

3. **调整显示**
   - 调整对比度和亮度
   - 使用Volume或Surface模块进行3D重建
   - 使用Filament模块进行血管追踪

## 体素大小估算

脚本根据图像尺寸自动估算扫描范围：

| 图像尺寸 | 估算扫描范围 | 横向分辨率 |
|---------|------------|-----------|
| 245x245 | 3x3 mm | ~12.2 µm |
| 320x320 | 4x4 mm | ~12.5 µm |
| 400x400 | 5x5 mm | ~12.5 µm |
| 490x490 | 6x6 mm | ~12.2 µm |

**深度方向**：通常为2mm / 1024像素 ≈ 1.95 µm

⚠️ **注意**：如果实际扫描参数不同，请修改脚本中的`calculate_voxel_size`函数。

## 常见问题

### Q: 为什么有些文件无法读取？
A: Zeiss导出的DICOM文件经常存在元数据损坏或压缩问题。脚本会跳过无法读取的文件，自动选择可读取的最佳体积。

### Q: 输出的TIFF文件在Imaris中看不到血管？
A: 可能原因：
1. 选择的文件是结构图（structural）而非血管造影图（angiography）
2. 需要调整Imaris中的对比度和亮度
3. 尝试不同的Volume Rendering模式

### Q: 如何判断哪个文件是血管造影图？
A: 检查预览图的En Face视图。血管造影图应该显示清晰的血管网络，而不是均匀的亮区。

### Q: 体素大小不正确怎么办？
A: 编辑`Zeiss_OCTA_Converter.py`中的`calculate_voxel_size`函数，根据实际扫描参数调整scan_width_mm的值。

## 技术细节

### 数据格式
- **输入**：DICOM文件（JPEG 2000压缩）
- **中间**：int8 [-128, 127] → uint8 [0, 255]
- **输出**：uint8 TIFF (Z, Y, X)

### 维度修正
Zeiss导出的某些文件中，Columns和NumberOfFrames的值会互换：
- 错误：Rows=245, Columns=1024, Frames=245
- 正确：Rows=245, Columns=245, Frames=1024

脚本会自动检测并修正此问题。

### 文件选择策略
1. 读取所有有效的3D体积
2. 按形状分组
3. 选择最常见的形状
4. 在该组中选择对比度最高的文件

## 版本历史

### v1.0 (2025-11-12)
- 初始版本
- 支持Zeiss Cirrus HD-OCT OCTA DICOM
- 自动修复元数据
- 自适应多种分辨率
- JPEG 2000解压缩

## 作者

UCSF OCTA分析自动化脚本

## 许可

供研究使用
